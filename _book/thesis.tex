\documentclass{aucklandthesis}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Add any LaTeX packages and other preamble here if required
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\author{ZHAOMING SU}
\title{Data Storytelling Dashboard for Exploring Auckland Air Quality}
\degrees{Bachelor of Science (Honours) in Statistics}
\supervisor{Dr.~Earo Wang}
\cosupervisor{Prof.~Chris Wild}
\def\degreetitle{}
% Add subject and keywords below
\hypersetup{
     %pdfsubject={The Subject},
     %pdfkeywords={Some Keywords},
     pdfauthor={ZHAOMING SU},
     pdftitle={Data Storytelling Dashboard for Exploring Auckland Air Quality},
     pdfproducer={Bookdown with LaTeX}
}


\bibliography{thesisrefs}

\begin{document}

\pagenumbering{roman}

\titlepage

{\setstretch{1.2}\rm\tighttoc\doublespacing}

\hypertarget{abstract}{%
\chapter*{Abstract}\label{abstract}}
\addcontentsline{toc}{chapter}{Abstract}

The abstract should outline the main approach and findings of the thesis and must not be more than 500 words.

\newpage

\hypertarget{acknowledgements}{%
\chapter*{Acknowledgements}\label{acknowledgements}}
\addcontentsline{toc}{chapter}{Acknowledgements}

I would like to express my sincere gratitude to my supervisor, Dr.~Earo Wang, for generously giving her time, knowledge and patient advice to guide my research. She is an outstanding supervisor and always supportive in sharing her rich experience in data visualisation and R programming, without which I could have never completed my first academic research and application development smoothly. I also appreciate my co-supervisor, Prof.~Chris Wild, for offering invaluable advice on data visualisation from a different aspect, inspiring creative ideas to improve my visualisation and web application.

I would also like to thank the scholarship office of the \emph{University of Auckland} for offering me the full postgraduate honours scholarship, which greatly relieved my financial hardship, allowing me to focus on my papers and research worry-free from essential costs from living, stationery and textbooks.

I would also like to thank all the developers and contributors of the \textbf{R} packages on the \emph{GitHub} community for responding to my queries, and most importantly, continually developing the packages.

Last but not least, I would like to thank my family for their unconditional love.

\hypertarget{copyright-notice}{%
\chapter*{Copyright notice}\label{copyright-notice}}
\addcontentsline{toc}{chapter}{Copyright notice}

\textcopyright { } \authorname~(\number\the\year).

I certify that I have made all reasonable efforts to secure copyright permissions for third-party content included in this dissertation and have not knowingly added copyright content to my work without the owner's permission.

\newpage

\hypertarget{declaration}{%
\chapter*{Declaration}\label{declaration}}
\addcontentsline{toc}{chapter}{Declaration}

This dissertation is an original work of my research and contains no material which has been accepted for the award of any other degree or diploma at any university or equivalent institution and that, to the best of my knowledge and belief, this dissertation contains no material previously published or written by another person, except where due reference is made in the text of the dissertation.

\clearpage\pagenumbering{arabic}\setcounter{page}{0}

\hypertarget{ch:intro}{%
\chapter{Introduction (Template Demo)}\label{ch:intro}}

This is where you introduce the main ideas of your thesis, and an overview of the context and background.

In a PhD, Chapter 2 would normally contain a literature review. Typically, Chapters 3--5 would contain your own contributions. Think of each of these as potential papers to be submitted to journals. Finally, Chapter 6 provides some concluding remarks, discussion, ideas for future research, and so on. Appendixes can contain additional material that don't fit into any chapters, but that you want to put on record. For example, additional tables, output, etc.

\hypertarget{rmarkdown}{%
\section{Rmarkdown}\label{rmarkdown}}

In this template, the rest of the chapter shows how to use Rmarkdown. The big advantage of using Rmarkdown is that it allows you to include your R code directly into your thesis, to ensure there are no errors in copying and pasting, and that everything is reproducible. It also helps you stay better organized.

For details on using \emph{R Markdown} see \url{http://rmarkdown.rstudio.com}.

\hypertarget{data}{%
\section{Data}\label{data}}

Included in this template is a file called \texttt{sales.csv}. This contains quarterly data on Sales and Advertising budget for a small company over the period 1981--2005. It also contains the GDP (gross domestic product) over the same period. All series have been adjusted for inflation. We can load in this data set using the following command:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sales <-}\StringTok{ }\KeywordTok{ts}\NormalTok{(}\KeywordTok{read.csv}\NormalTok{(}\StringTok{"data/sales.csv"}\NormalTok{)[, }\DecValTok{-1}\NormalTok{], }\DataTypeTok{start =} \DecValTok{1981}\NormalTok{, }\DataTypeTok{frequency =} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Any data you use in your thesis can go into the data directory. The data should be in exactly the format you obtained it. Do no editing or manipulation of the data outside of R. Any data munging should be scripted in R and form part of your thesis files (possibly hidden in the output).

\hypertarget{figures}{%
\section{Figures}\label{figures}}

Figure \ref{fig:deaths} shows time plots of the data we just loaded. Notice how figure captions and references work. Chunk names can be used as figure labels with \texttt{fig:} prefixed. Never manually type figure numbers, as they can change when you add or delete figures. This way, the figure numbering is always correct.

\begin{figure}
\centering
\includegraphics{thesis_files/figure-latex/deaths-1.pdf}
\caption{\label{fig:deaths}Quarterly sales, advertising and GDP data.}
\end{figure}

\hypertarget{results-from-analyses}{%
\section{Results from analyses}\label{results-from-analyses}}

We can fit a dynamic regression model to the sales data.

If \(y_t\) denotes the sales in quarter \(t\), \(x_t\) denotes the corresponding advertising budget and \(z_t\) denotes the GDP, then the resulting model is:
\begin{equation}
  y_t - y_{t-4} = \beta (x_t-x_{t-4}) + \gamma (z_t-z_{t-4}) + \theta_1 \varepsilon_{t-1} + \Theta_1 \varepsilon_{t-4} + \varepsilon_t
\end{equation}
where
\(\beta = 2.28\),
\(\gamma = 0.97\),
\(\theta_1 = NA\),
and
\(\Theta_1 = -0.90\).

\hypertarget{tables}{%
\section{Tables}\label{tables}}

Let's assume future advertising spend and GDP are at the current levels. Then forecasts for the next year are given in Table \ref{tab:salesforecasts}.

\begin{table}[ht]
\begin{center}
\begin{tabular}{lllll}
\toprule
Point Forecast & Lo 80 & Hi 80 & Lo 95 & Hi 95 \\
\midrule
1000.2 &  947.7 & 1052.7 & 919.9 & 1080.5 \\
1013.1 &  959.3 & 1066.8 & 930.9 & 1095.3 \\
1076.7 & 1022.9 & 1130.6 & 994.4 & 1159.0 \\
1003.5 &  949.7 & 1057.4 & 921.2 & 1085.8 \\
\bottomrule
\end{tabular}
\caption{Forecasts for the next year assuming Advertising budget and GDP are unchanged.}
\label{tab:salesforecasts}
\end{center}
\end{table}

Again, notice the use of labels and references to automatically generate Table numbers. In this case, we need to generate the label ourselves.

The \texttt{knitLatex} package is useful for generating tables from R output. Other packages can do similar things including the \texttt{kable} function in \texttt{knitr} which is somewhat simpler but you have less control over the result. If you use \texttt{knitLatex} to generate tables, don't forget to include \texttt{results="asis"} in the chunk settings.

\hypertarget{ch:litreview}{%
\chapter{Research and related works}\label{ch:litreview}}

Modern information design has been continuously fostering effective tools of organising and displaying information since \textcite{tufte} proposed the landmarking principles of graphical displays in \emph{The Visual Display of Quantitative Information}. Following the disruptive advancement of information and computing technology, infographics designers are faced with unprecedented methods of data display, including interactive and animated graphics.

As such, the prerequisites of a successful design of a storytelling dashboard for visualising the air quality data are the appropriate implementations of suitable data and graphical toolboxes. As the main features of interest in air quality data are temporal, this section will briefly outline the available toolboxes for time series data wrangling and visualisation using \textbf{R} \autocite{R2021}.

\hypertarget{tidy-time-series-data-wrangling-toolbox}{%
\section{Tidy time series data-wrangling toolbox}\label{tidy-time-series-data-wrangling-toolbox}}

The \textbf{tsibble} package offers a data infrastructure for wrangling time series data \autocite{tsibble}. A time series data set consists of one or more sequences indexed by time, often with a regular interval. As such, data-wrangling processes of time series data need to account for the special requirements of time series data analysis, including the explicit identification of time gaps and a method of handling multiple time series in a single data set for identifying duplicate records.

Analyses of fixed-interval time series require the data to be free from missing value, especially when the series is self-dependent. Whilst the explicit missing values can be easily handled by the substitution with interpolated values, the implicit gaps with missing index values are often neglected. In the case of multiple time series, locations of implicit time gaps may be different in each sequence; filling the gaps with traditional loops can be time-consuming and inefficient. \textbf{tsibble} identifies implicit time gaps with the \emph{index} and \emph{key} variables, such that each variable in the tsibble object is uniquely identified by the index and the interaction of all keys. As such, each time series is uniquely identified by the keys, allowing efficient identification of implicit time gaps, which is achieved by \textbf{tsibble} with a range of wrangling verbs.

Duplicates exist in different forms in cross-sectional and time series data. Typically, duplicates are identical observations exhibited as rows in a data frame, yet such definition is inadequate in identifying duplicates in time series data. There exists only one true value at any given point in time for each time series, meaning that there may be duplicate values that are non-identical observations with identical key-index pairs yet different in values. Instead of searching merely for duplicate rows, \textbf{tsibble} checks for duplicate key-index pairs. To avoid negligence, the creation of tsibble will fail upon detected duplicates.

\hypertarget{time-series-graphics-toolbox}{%
\section{Time series graphics toolbox}\label{time-series-graphics-toolbox}}

\hypertarget{calendar-graphics}{%
\subsection{Calendar graphics}\label{calendar-graphics}}

Calendars are the systematic partition of time from the observed solar-lunar phenomena and cultural custom, which is usable as graphics for temporal representations of societal activities and natural events. Calendar graphics are the method for the aggregated visualisation of time series data at sub-daily intervals, depicting the temporal dimension of time series data as the spatial layout in the calendar grid. The motivation of utilising calendars for data visualisations arises from the convenience of displaying observations in association with exact dates.

Air quality data are conventionally collected at hourly intervals, from which a time series plot becomes overcrowded, impeding the visual detections of abnormalities. \textcite{calmap} depicted a method of non-cartesian heatmaps on a calendar coordinate for visualising air pollution data. Prior to the paper, \textcite{calmapi} used calendar heatmaps to analyse the correlation of particulate matter temporally. Calendar graphics highlight the abnormalities and allow the association of the detected abnormalities to events with dates, providing insights and directions for analyses.

Calendar graphics is an application of trellis displays \autocite{trellis}, which spatially modularise the temporal dimension into conditional groups of small multiples \autocite{tufte} using calendar period (i.e., month and year) as an integrated and aligned plot. The expanded layout of the temporal dimension on a plane eases the cognitive load \autocite{tufte} in temporally locating the date of the events and extracting the date components, contrary to conventional time series plots.

\begin{figure}
\includegraphics[width=1\linewidth]{figures/cal-demo} \caption{Calendar heatmap. Produced with \textbf{Echarts.js} \autocite{echarts} via \textbf{echarts4r} \autocite{echarts4r} faceted (unaligned) by \texttt{year\ \textasciitilde{}\ month}. Each tile corresponds to the value of an observed day or aggregated sub-daily observations, whose exact date and day of the week are easily identifiable.}\label{fig:cal-demo}
\end{figure}



\hypertarget{time-series-plots}{%
\subsection{Time series plots}\label{time-series-plots}}

In most scenarios, visualising time series relies on connecting points of observations with lines, curves or splines \autocite{dataviz-ts}, such that the sequences are plotted against the time index by positions along common xy-scales on the Cartesian coordinate \autocite{fpp3}. Connected time plots are the most elementary visual method for spotting extrinsic features in time series, including trends, seasons, cycles, clustering and oscillations.

\begin{figure}
\includegraphics[width=1\linewidth]{thesis_files/figure-latex/ctp-demo-1} \caption{Line plot. Produced with the \textbf{ggplot2} package \autocite{ggplot2} for the weekly economy passenger load on Ansett Airlines \autocite{fpp3d}. Visual analysis shows weak trend and cycle and abnormal zero values to be investigated. The presence of clustering also indicates a positive temporal dependence in the time series. It is nonetheless uneasy to align any observation to a date accurately.}\label{fig:ctp-demo}
\end{figure}



Based on connected time plots, \textcite{feasts} proposed the seasonal plot as a method of visualising seasonal patterns in the \textbf{feasts} package. The method conditionally subsets the complete time series into partitions of seasonal periods, each to be plotted in a homogeneous time plot and distinguished using a gradient colour scale for longitudinal comparison between periods.

\begin{figure}
\includegraphics[width=1\linewidth]{thesis_files/figure-latex/stp-demo-1} \caption{\textbf{ggplot2}-based seasonal time series plot. Produced with the \textbf{feasts} package for the monthly anti-diabetic drug sales in Australia \autocite{fpp3d}. The plot allows for both visualisation of intra-seasonal patterns and inter-seasonal variations shown as a positive trend in drug sales from year to year.}\label{fig:stp-demo}
\end{figure}



Nevertheless, interpreting connected time plots relies on the visual alignment of positions to the xy-scales in the Cartesian coordinates. Such visual alignments can be challenging upon the absence of explicit gridlines and axes, such as when the plot is fitted as a part of trellis displays \autocite{trellis}, in which the trend and scale of variations become ambiguous. As such, it is common to fill the area under the curve to emphasise the temporal variation in the plot \autocite{dataviz-ts}.

\hypertarget{html-widgets-for-interactive-graphics}{%
\section{HTML widgets for interactive graphics}\label{html-widgets-for-interactive-graphics}}

\hypertarget{sec:shiny}{%
\subsection{Development of web applications with R}\label{sec:shiny}}

The \textbf{shiny} package \autocite{shiny} provides a framework for developing web applications with \textbf{R} code \autocite{R2021}, both user and developer-friendly. It enables \textbf{R} users with no prior knowledge of HTML, CSS and JavaScript to create custom web applications with sophisticated functionality with template UI components and a server powered with reactive programming.

Reactive programming focuses only on the evaluation of the changes of values over time, which is the core computation logic behind \textbf{shiny} \autocite{mshiny}, significantly simplifying the workflow design. Each change in reactive values is observed as an event by pre-defined callback functions, and workflows are executed as responses to events observed. Reactivity is cached such that the reactive values keep the previously evaluated result for each call, as callbacks to them upon event observations update the reactive once and globally, thus consistent for being shared across different functionalities. The cached feature of reactivity allows users in defining abstract workflows without conceiving low-level data and programming logic by restricting the evaluation to merely reactions to events, including user actions and internal value change. Reactivity is also lazy, for no expressions are evaluated until being called, which avoids repeated evaluations of expressions leading to wastage in computational resources.

The user interface of \textbf{shiny} applications provides the front-end inputs and output display from the back end server logic. The collection of user input is the primary source of change of reactive values, events that trigger the evaluation of expressions in the back end server logic. The results of the evaluated expressions are rendered as the outputs, which may be as simple as prints of R objects or as sophisticated as HTML interactive graphics.

\hypertarget{sec:int-graphics}{%
\subsection{Interactive graphics}\label{sec:int-graphics}}

It is usually tempting to fit all the information in a single display upon data visualisation. To avoid excessive cognitive load to viewers, the need for selective presentation of information motivated the introduction of interactive graphics \autocite{intg}. The primary purpose of utilising graphical interactivity is to provide a navigated data exploration, either coarse-to-granular or the opposite, such that only the user-chosen details of a broad summary are dynamically shown, reducing the wastage of limited spatial recourses on display. Alternatively, interactive graphics are used to establish dynamic linkings between plots \autocite{intg}.

The selective presentation of information in interactive graphics is mainly achieved by hover-over tooltips and drill-down. Tooltips, initially introduced by \textcite{tt} in \emph{Windows NT 3.51}, refer to tags of brief descriptive messages upon hovering over graphical elements in the context of interactive graphics, temporarily hiding granular details of a coarser summary until user input which allows a top-down approach to preliminary data exploration. Nevertheless, tooltips are dynamic displays that vanish as the cursor moves away. As such, drill-down \autocite{plotly} and click triggered popups are often used as supplements to tooltips in need of stable auxiliary graphics.

\begin{figure}
\includegraphics[width=1\linewidth]{figures/tt-demo} \caption{A demonstration of tooltips with \textbf{Echarts.js} via \textbf{echarts4r}. A tag with informative messages including the date and observed AQI value is shown upon cursor hover-over the data point.}\label{fig:tt-demo}
\end{figure}



Linked views of multiple graphics are a powerful method for deconstructing high-dimensional data, achieved via either client or server-side linking \autocite{plotly}. The client-side linking employs internal graphical queries without callbacks to the application server, with examples including internal connections (e.g., brush and linked filters) in \textbf{plotly} \autocite{plotly} and \textbf{echarts4r} \autocite{echarts4r}. Alternatively, server-side linkings involve queries to the server environment via callbacks (Section \ref{sec:shiny}), mainly for intermodular linking of different types of plots.

A special application of server-side linking is to facilitate selection control in interactive maps. In addition to the positioning and navigational functions of interactive maps, they are a native geographical user interface for click or hover-and-show inputs and outputs.

\hypertarget{visual-analysis-for-temporal-air-quality-data}{%
\section{Visual analysis for temporal air quality data}\label{visual-analysis-for-temporal-air-quality-data}}

Temporal air quality data requires domain-specific graphic tools for exploratory visual analysis. This section covers examples of visualising air quality in meteorological and temporal aspects.

\hypertarget{sec:wind-rose}{%
\subsection{Wind roses}\label{sec:wind-rose}}

Wind speed and direction are critical meteorological parameters that affect the concentration of ambient air pollutants by altering their transportation, diffusion and accumulation \autocite{wind}. The visual evaluation of wind as vectors requires specialised graphics capable of depicting the directional nature of wind. In conjunction with the requirement for visual association analysis between wind and air pollution, a temporal-proportion-based wind rose plot is proposed and implemented on the \textbf{openair} package \autocite{openair}, which is an application of the stacked polar bar plots. Variations of temporal-proportion wind rose plots include contour wind roses \autocite{cwr} and standard vector-deviation wind roses \autocite{vdwr}. A temporal-proportion wind rose can be extended to pollution rose, replacing the mapping of wind speed to pollutants.

\begin{figure}
\includegraphics[width=1\linewidth]{thesis_files/figure-latex/wr-demo-1} \caption{Pollution rose. Produced with \textbf{openair} \autocite{openair}, which depicts the proportion of time (radius of the segmental arches) the wind is bounded from each direction (angle) observing the levels of NOx (colour).}\label{fig:wr-demo}
\end{figure}



\hypertarget{autocorrelation-plots}{%
\subsection{Autocorrelation plots}\label{autocorrelation-plots}}

Trend analysis of ambient air pollutant concentrations is a critical component of the air quality management strategy \autocite{aqi}, which is commonly carried out preliminarily with linear models. Nonetheless, mutual independence of the residuals is the core assumption of all linear models; as such, the temporal dependence of air quality data between successive observations needs to be captured \autocite{lm}. The autocorrelation plots visually provide preliminary insights into the type of correlation structure present in the series prior to analysis \autocite{acf}. The autocorrelation plots are also a tool for model diagnostics and evaluation.

\begin{figure}
\includegraphics[width=1\linewidth]{thesis_files/figure-latex/acf-demo-1} \caption{A \textbf{ggplot2}-based autocorrelation plot (left) and partial autocorrelation plot (right) of quarterly lags with the \textbf{feasts} package for Australian beer production \autocite{fpp3d}. The sample (partial) autocorrelation function of each lag is compared to a significance threshold of \(\pm \frac{\phi^{-1} (1 - \frac{\alpha}{2})}{\sqrt{n}}\).}\label{fig:acf-demo}
\end{figure}



\hypertarget{ch:data}{%
\chapter{Auckland air quality data}\label{ch:data}}

\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

Air quality index (AQI) is a critical indicator of overall air quality by measuring key air pollutant concentrations at a given time. The constitution of AQI consists of ambient air pollutants listed in the National Environmental Standards for Ambient Air Quality which defines the threshold target for calculating AQI \autocite{aqi}. The national standard defines AQI as the maximum ambient air pollutant measurement ratio to the national target as a percentage \autocite{aqitarget}. Over ten stations in Auckland monitor a subset of the listed pollutants in an hourly interval.

It is of interest to visually explore the variation and relationships of AQI and its constituent pollutants over time. The data, provided by \textcite{aklenvdata}, includes 11 air pollution parameters from 10 monitoring stations in Auckland from as North as Takapuna to as South as Patumahoe. The available parameters consist of air quality index (AQI) and ten pollutants as per Table \ref{tab:raw-dataset}, with various starting dates (since as early as 2003 in Takapuna) until April 2021.

Only six of the standard-listed air pollutants are monitored and available in the data, and each station independently monitors a subset of the six pollutants. As such, the calculation of AQI, based on available data, may be simplified to

\begin{equation}\label{eq:aqicon} AQI = 100 \times \textrm{max}\{\frac{PM_{2.5}}{25}, \frac{PM_{10}}{50}, \frac{NO_{2}}{200}, \frac{SO_{2}}{350}, \frac{CO}{10}, \frac{O_{3}}{150}\} \end{equation}

\begin{table}[ht]
\begin{center}
\begin{tabular}{lll}
\toprule
Parameter & Unit & Note \\
\midrule
AQI &  & Air quality index \\
BC(370) & ngm\textsuperscript{-3} & Black carbon at 370nm wavelength \\
BC(880) & ngm\textsuperscript{-3} & Black carbon at 880nm wavelength \\
CO\textsuperscript{*} & mgm\textsuperscript{-3} & Carbon monoxide concentration \\
NO & \textmu gm\textsuperscript{-3} & Nitrogen monoxide concentration \\
NO\textsubscript{2}\textsuperscript{*} & \textmu gm\textsuperscript{-3} & Nitrogen dioxide concentration \\
NOx & \textmu gm\textsuperscript{-3} & Nitrogen oxides concentration \\
O\textsubscript{3}\textsuperscript{*} & \textmu gm\textsuperscript{-3} & Ozone concentration \\
PM2.5\textsuperscript{*} & \textmu gm\textsuperscript{-3} & Particulate matter with diameter <2.5\textmu m \\
PM10\textsuperscript{*} & \textmu gm\textsuperscript{-3} & Particulate matter with diameter <10\textmu m \\
SO\textsubscript{2}\textsuperscript{*} & \textmu gm\textsuperscript{-3} & Sulphur dioxide concentration \\
\bottomrule
\end{tabular}
\caption{Parameters available in the raw data.\\\textsuperscript{*} AQI-related ambient air pollutants}
\label{tab:raw-dataset}
\end{center}
\end{table}

It is noteworthy that the availability of air quality parameters in each monitoring station varies from year to year. Besides, the extreme values addressed in Section \ref{sec:data-extreme-value} are more frequent in earlier years. The final data set is thus taken since the year 2016.

\hypertarget{data-enrichment}{%
\section{Data enrichment}\label{data-enrichment}}

\hypertarget{supplementary-meteorological-data}{%
\subsection{Supplementary meteorological data}\label{supplementary-meteorological-data}}

The air quality index is presumably affected by various environmental and meteorological factors, such as wind as per Section \ref{sec:wind-rose}, which are included as supplementary variables.

\begin{table}[ht]
\begin{center}
\begin{tabular}{ll}
\toprule
Variable & Unit \\
\midrule
Relative humidity & \% \\
Temperature & $^{\circ}$C \\
Wind speed & ms\textsuperscript{-1} \\
Wind direction & $^{\circ}$ \\
\bottomrule
\end{tabular}
\caption{Supplementary meteorological variables.}
\label{tab:met-dataset}
\end{center}
\end{table}

\hypertarget{categorisation-of-air-quality-index}{%
\subsection{Categorisation of air quality index}\label{categorisation-of-air-quality-index}}

The value of the air quality index derived from relevant pollutants is numerically non-intuitive and does not provide perceptual implications to the state of air quality per se, which leads to the proposal of standard classification by evaluating potentially imposed health risk \autocite{aqidef}. Notwithstanding the absence of an officially promulgated standard for the classification of air quality index in New Zealand \autocite{nzaqrg}, variations of the United States standards of reporting air quality index \autocite{usaqrs} are generally accepted worldwide. The health risk warnings-driven categorisation of the air quality index delivers an immediate message about the current status of air quality and asserts behavioural influence to the public with colours \autocite{colwarn}.

\begin{table}[ht]
\begin{center}
\begin{tabular}{lll}
\toprule
AQI Level of Concern & Value of Index & Colour (Hexadecimal Code) \\
\midrule
Good & 0 to 50 & \colorbox[rgb]{0,.89,0}{\textcolor[rgb]{0,.89,0}{**}} Green {\fontfamily{pcr}\selectfont (\#00E400)} \\
Moderate & 51 to 100 & \colorbox[rgb]{1,1,0}{\textcolor[rgb]{1,1,0}{**}} Yellow {\fontfamily{pcr}\selectfont (\#FFFF00)} \\
Unhealthy for sensitive groups & 101 to 150 & \colorbox[rgb]{1,.49,0}{\textcolor[rgb]{1,.49,0}{**}} Orange {\fontfamily{pcr}\selectfont (\#FF7E00)} \\
Unhealthy & 151 to 200 & \colorbox[rgb]{1,0,0}{\textcolor[rgb]{1,0,0}{**}} Red {\fontfamily{pcr}\selectfont (\#FF0000)} \\
Very unhealthy & 201 to 300 & \colorbox[rgb]{.56,.25,.59}{\textcolor[rgb]{.56,.25,.59}{**}} Purple {\fontfamily{pcr}\selectfont (\#8F3F97)} \\
Hazardous & 301 and higher & \colorbox[rgb]{.49,0,.14}{\textcolor[rgb]{.49,0,.14}{**}} Maroon {\fontfamily{pcr}\selectfont (\#7E0023)} \\
\bottomrule
\end{tabular}
\caption{The United States definition of AQI categories and colours (\cite{usaqrs}). Note that AQI is always rounded to the nearest integer.}
\label{tab:aqi-cat}
\end{center}
\end{table}

\hypertarget{categorisation-of-wind-direction}{%
\subsection{Categorisation of wind direction}\label{categorisation-of-wind-direction}}

The implementation of the wind rose method of visualising meteorological wind data outlined in Section \ref{sec:wind-rose} is made interactable by \textbf{echarts4r} \autocite{echarts4r} without any direct call to the \textbf{openair} package. Thus, the wind direction variable is converted into a 12-level factor of equal 30-degree intervals, the default option for the \texttt{windRose()} function in \textbf{openair} \autocite{openair}, as part of the data preparation process. The process of correcting directional bias by default in \textbf{openair} is excluded as the variable is unrounded \autocite{cdbias}.

\hypertarget{data-quality-and-cleaning}{%
\section{Data quality and cleaning}\label{data-quality-and-cleaning}}

The raw data consists of two separate data sets, each with a different data structure. Cleaning and manipulation are needed to ensure that the two data sets are consistent in structure and free from error. The raw data sets are individually inspected and cleaned before combination. This section outlines the issues found and methods to address them.

\hypertarget{sec:data-extreme-value}{%
\subsection{Abnormal and missing values}\label{sec:data-extreme-value}}

Abnormal or missing values arise from instrumental or input errors. Upon inspection, 104,332 records were found to have a negative value. Nevertheless, all pollutants are reported in units in the form of mass per unit volume, and other parameters, except for temperature, are only sensible if positive as of Table \ref{tab:raw-dataset}. Therefore, 104,257 records of insensible negative values are removed. Besides, conspicuously anomalous records of AQI are found in data, including consecutive hours of \textgreater1,000 AQI in Takapuna and numerous AQI values being inconsistent with Formula \ref{eq:aqicon} based on available pollutants in the same data set. The anomalous records are nonetheless kept as-is for further verification.

In addition, preliminary inspection finds that 0.81\% of records are explicitly missing. Yet after filling the implicit time gaps in the data, 53.71\% of records are implied to be missing.

\hypertarget{date-and-time}{%
\subsection{Date and time}\label{date-and-time}}

A consistent format in date and time is crucial to the accuracy of temporal data. Observations with inconsistent time format are present in the data, where some are recorded in \texttt{hh:mm:ss} whilst others in \texttt{hh:mm}. The inconsistency in the time format is correctable due to the hourly nature of the data. 0.06\% of records with missing time are removed.

The time zone of New Zealand changes by +1 during daylight saving. To avoid duplicated index upon boundaries of daylight saving upon data visualisation, all time-stamps are presented in NZST (UTC+12). On the other hand, the date and time in the cleaned data file are stored as a single variable, with its format in compliance with ISO 8601 \autocite{iso8601,readr}.

\hypertarget{duplicate-records}{%
\subsection{Duplicate records}\label{duplicate-records}}

Temporal data should not present duplicate records. Of the 7,292,038 valid records, 239,374 (3.28\%) are duplicate with 120,207 redundant records. Further checking reveals that 230,822 of the duplicates have inconsistent values. However, as the scale of the inconsistency of most duplicate records is reasonably small, the first-appearing records of each duplicate are kept.

\hypertarget{structural-difference-in-raw-data-sets}{%
\subsection{Structural difference in raw data sets}\label{structural-difference-in-raw-data-sets}}

The primary data set, which records all parameters except for wind direction, is in long format, with each observation consisting of a single record of one parameter for one station at a given hour. Nevertheless, each observation of the wind direction data set consists of wind direction records of all stations at a given hour. Each data set is pivoted to the structure such that each observation is uniquely identified by the date-time and station with records of all parameters before combination to ensure structural consistency.

\hypertarget{ch:design}{%
\chapter{Design layout and philosophy}\label{ch:design}}

\hypertarget{introduction-1}{%
\section{Introduction}\label{introduction-1}}

The ambient air quality data possesses spatial and temporal properties, whose variation is affected by the proliferation of pollutants over time. Spatially, it is of interest to compare and contrast the ambient air pollutant levels in different locations in Auckland to explore the geographical effect on AQI, possibly due to transportation or meteorological factors. As such, the visualisations throughout the application is in the context of the user-selected location. On the other hand, the variation of AQI in Auckland has been stable since first monitored, and its expectation is consistently in the \emph{healthy} category. Thence, the primary objective of visualising Auckland air quality data is to locate the anomalies temporally and investigate the causes of the unusually high AQI levels. As such, this application provides a coarse-to-granular approach for exploring Auckland air quality data. This application also provides a preliminary understanding of the variation of the air quality index in Auckland and its link to meteorological factors.

\hypertarget{overviewing-aqi}{%
\section{Overviewing AQI}\label{overviewing-aqi}}

\begin{figure}
\includegraphics[width=1\linewidth]{figures/aqi-tab} \caption{The Air Quality tab provides an overview of the air quality status in Queen Street for 2019. The left calendar heatmap shows two days of extremely high AQI level in the fourth week of October 2019 (which was caused by the fire in New Zealand International Convention Centre). In addition, the right calendar heatmap shows the daily primary constituent of ambient air pollutants from the calculation of AQI.}\label{fig:unnamed-chunk-2}
\end{figure}



\hypertarget{spatial-visualisation}{%
\subsection{Spatial visualisation}\label{spatial-visualisation}}

Maps intuitively depict the spatial properties of air quality data. The generation and transportation of air pollutants are dependent on the interactions of numerous geographical and meteorological factors, including traffic activities, industrial density and wind. Thus, maps are the optimal solution for spatially presenting all the aforementioned factors, as well as displaying the relative direction between multiple locations. Maps also provide a geographical interface for users to select the locations of interest. Clicks on the interactive map update all the visualisations in the application globally to the selected location.

\hypertarget{temporal-visualisation}{%
\subsection{Temporal visualisation}\label{temporal-visualisation}}

Calendar heatmaps offer a daily-aggregated visualisation of AQI data for both anomaly detections and the exploration of its constituents with colour-coding. Through the daily aggregation of AQI levels with the maxima, the user is able to spot days with unusually high AQI levels efficiently (blocks with colours other than green or yellow). The calendar coordinate of heatmaps also enables the users to temporally locate the date components (e.g., the day of the week) of the incident accurately, which is a feature a time series plot does not possess. Alternatively, the coloured block of the calendar heatmaps is utilised for displaying the daily primary constituent of ambient air pollutants from AQI with tooltips.

The layout orientation of the calendar heatmaps is set as vertical to conform to the browsing habit of most users. Most users of digital devices nowadays are heavily influenced by the increasing usage time of smartphones, such that they are getting used to viewing information displayed from top-to-bottom, from the act of scrolling down for more information. Coincidentally, the orientation of the distribution of the monitor stations of ambient air pollutants in Auckland is north-southern. As such, both the maps and calendar heatmaps are laid out in a vertical, top-down orientation.

\begin{figure}
\includegraphics[width=1\linewidth]{figures/cal-drill-down} \caption{The drill-down hourly time series plot for Queen Street AQI on October 23, 2019, along with the AQI thresholds and hourly quantiles. AQI levels on the day were consistently higher than normal and are in the Very Unhealthy category. Note that the fire in New Zealand International Convention Centre actually broke out on October 22, 2019. The delay in rising AQI was caused by some of the constituent pollutants of AQI being reported at a 24-hour moving average \autocite{aqitarget}.}\label{fig:unnamed-chunk-3}
\end{figure}



Users may wish to explore the variation of the AQI level of the anomalous days in more granular details to investigate if the extreme AQI values are consistent for hours or arise from instrumental errors. The drill-down methodology allows users to click on the day-representing calendar blocks to request more information, from which a popup time series plot serves as a supplementary visualisation of the hourly AQI variation on the day of interest, as well as the plot for the daily primary AQI constituent.

\hypertarget{data-enrichment-1}{%
\section{Data enrichment}\label{data-enrichment-1}}

\hypertarget{meteorological-analysis-of-air-quality}{%
\subsection{Meteorological analysis of air quality}\label{meteorological-analysis-of-air-quality}}

\begin{figure}
\includegraphics[width=1\linewidth]{figures/met-tab} \caption{The interactive HTML table produced with \textbf{reactable} \autocite{reactable} for the air quality and meteorological data from Queen Street in October 2019. The spiked AQI from the fire in New Zealand International Convention Centre is clearly visible.}\label{fig:unnamed-chunk-4}
\end{figure}



One may be in the interest of concurrently visualising air quality and meteorological data to explore if they correlate in the form of multiple time series. For consistency, the visualisation is structured via a calendar layout (similar to the \emph{Air Quality} tab). The resulting form from the combination of multiple time series plots and the calendar layouts is an interactive HTML table with sparkline bars \autocite{sparkline}, such that the hourly bars from each week of a selected month are in grouped rows with the day of the week grouped in columns, enabling visualisation by day, week and month.

\hypertarget{exploring-the-effect-of-air-current-on-aqi}{%
\subsection{Exploring the effect of air current on AQI}\label{exploring-the-effect-of-air-current-on-aqi}}

\begin{figure}
\includegraphics[width=1\linewidth]{figures/wind-tab} \caption{The monthly wind (pollution) roses depict the proportion of time wind comes from a particular direction grouped by AQI category, suggesting that most of the time in 2019 the wind direction in Queen Street is northbound. Moreover, it is shown that the wind directions are approximately perpendicular to the closest coastline.}\label{fig:unnamed-chunk-5}
\end{figure}



The directional nature of wind direction makes its visualisation challenging with conventional methods for visualising time series. On the other hand, standard wind or pollution rose is incapable of depicting the temporal features of time series. Thus, monthly wind roses arranged in a grid is particularly helpful in displaying the temporal variation wind directions and corresponding grouping of the AQI categories.

The layout of the \emph{Wind} tab is made consistent with the spatial-temporal visualisation scheme as per the \emph{Air Quality} tab, allowing the users to relate the wind directions displayed on the wind roses with the geographic and geological features surrounding the selected locations on the interactive map.

\hypertarget{data-analysis}{%
\section{Data analysis}\label{data-analysis}}

\hypertarget{sec:trend-viz}{%
\subsection{Visual trend analysis}\label{sec:trend-viz}}

\begin{figure}
\includegraphics[width=1\linewidth]{figures/ts-tab} \caption{The time series plot suggested no evidence of a change in AQI value from 2019 to 2020 in Queen Street, after correcting for autocorrelation with AR(2) model, which is given from the ACF and PACF plots of the observed AQI series. The trend is estimated arithmetically (in absolute value), and can also be switched to geometric.}\label{fig:unnamed-chunk-6}
\end{figure}



The Auckland Regional Council analyses the trend of air quality index as an evaluation of the efficiency of their air quality management strategy. Time series visualisation provides a preliminary visual insight of the temporal trend and directions for further analysis. A line plot of the observed AQI with the fitted trend series overlaid with appropriate intervals provides an intuitive visual for the change in air quality over a specified period. Due to the stableness of air quality in Auckland for the past number of decades, the long-term direction of temporal variation of air quality index is visually indistinguishable. Thus, the trend (annual change) and the \emph{p}-value of the trend are labelled as textual annotations.

Nevertheless, the correlation structure in the AQI time series biases the trend estimates. The temporal dependence of the series needs to be captured by the trend model. On the other hand, the model for preliminary visual analysis should avoid being over-complicated. A simple autoregressive model up to an order of three (Appendix \ref{ch:model-output}) is implemented along with the trend model.

Interpretation of the long-term variation in the air quality index is more meaningful in percentage than by absolute value due to its unitless nature. In addition that the AQI values are positive, modelling the trend with the geometric mean instead of arithmetic mean is offered as a user-selectable option.

One also may be in the interest of knowing the variations of AQI explained by the correlation structure of the series itself. To visually depict such a feature, an as-if one-step-ahead prediction interval instead of a confidence interval provides insight into the predictive power of the time series model.

One also may be in the interest of knowing the variations of AQI explained by the correlation structure of the series itself. To visually depict such a feature, an as-if one-step-ahead prediction interval instead of a confidence interval provides insight into the predictive power of the time series model. As of now, the focus is shifted to the variance of time series; heteroscedasticity also needs to be captured by the model. As such, the \emph{GARCH} model can be enabled by the user with an option.

\hypertarget{predictive-analysis}{%
\subsection{Predictive analysis}\label{predictive-analysis}}

From the preliminary findings in Section \ref{sec:trend-viz}, an autoregressive adjusted trend model possesses poor predictive power to AQI, and as per the link established between the concentration of ambient air pollutants and meteorological factors in \textcite{wind}, a predictive model is fitted in the attempt to verify the correlation between the AQI in Auckland with a set of meteorological variables.

As of the inconsistent data quality and the range of data availability across different locations outlined in Chapter \ref{ch:data}, the analysis is broken down into separate and independent models by each location, and only data from the locations with less than 20\% missing rate are kept and deemed to be adequate for time series models (Appendix \ref{ch:model-output}).

The AQI data from selected locations are wangled prior to analysis. To ensure the temporal continuity of the data for time series modelling, the time gaps in the series are filled with the locational mean as the interpolated values. The hourly observations are aggregated into daily to reduce unwanted noises. In particular, wind data are vectors that cannot be aggregated with numerical averaging. With such a feature in consideration, the hourly wind directions and speeds are aggregated into daily observations by the vector means, with wind speed being the vector modulus and direction being the argument. In addition, the numeric wind direction (in degrees) is converted into a categorical factor (with 12 levels), as gradients of AQI to wind direction is meaningless due to its directional nature.

The best-fit model is selected from an exhaustive search from the sub-models ranked by \emph{AICc}, which fits the response from all the covariates, the interaction effect of all factors and the up to three lagged responses suggested by the autocorrelation plots in Appendix \ref{ch:model-output}. The predictive evaluation of the final best-fit models returns a \emph{root mean squared error of prediction} below 10 for all locations except for Henderson. Considering the normal interval width of the AQI category is 50 as per Table \ref{tab:aqi-cat}, data models with meteorological variables provide moderate predictive power to AQI, along with the ANOVA tables, the weather likely has a significant influence on AQI.

\hypertarget{ch:linking}{%
\chapter{Shiny linking and reactivity}\label{ch:linking}}

\hypertarget{introduction-2}{%
\section{Introduction}\label{introduction-2}}

The application consists of several functional components for a set of independent visualisation tasks, motivating a modularised approach in structuring the application. To facilitate the linking between the graphical user interfaces and each of the visualisation components, reactive caching is responsible for the communication between the modules and the recording and updating of user inputs and graphical outputs. The section outlines the utilisation of reactivity for the linking in the modularised application.

\begin{figure}
\includegraphics[width=1\linewidth]{figures/app-structure} \caption{The structure of the modularised shiny application.}\label{fig:unnamed-chunk-7}
\end{figure}



This section, as a typical example, outlines the application of linking and reactivity on the user selection of monitor stations with interactive maps in the modularised application.

\hypertarget{modularisation-of-shiny-application}{%
\section{Modularisation of shiny application}\label{modularisation-of-shiny-application}}

The modular division of the shiny application allows the development and deployment of components to be independent of one another, enabling flexible addition and modification of functions. Each shiny module represents a dedicated functional component of the application. The modules are black boxes that are isolated and only communicate with other modules via a defined global reactive. The isolation of modules avoids unwanted interference among modules, simplifying the workflow control.

\hypertarget{module-environment}{%
\subsection{Module environment}\label{module-environment}}

Each of the shiny modules consists of its independent UI and server, much similar to a miniature ``shiny environment'', called within the application UI and server.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{map_aqi_ui <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(id) \{}
\NormalTok{  ns <-}\StringTok{ }\KeywordTok{NS}\NormalTok{(id)}
  \KeywordTok{tagList}\NormalTok{(}\KeywordTok{leafletOutput}\NormalTok{(}\KeywordTok{ns}\NormalTok{(}\StringTok{"map_aqi"}\NormalTok{), }\DataTypeTok{height =} \StringTok{"1190px"}\NormalTok{))}
\NormalTok{\}}

\NormalTok{map_aqi_mod <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(id, state) \{}
\NormalTok{  module <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(input, output, session) \{}
\NormalTok{    output[[}\StringTok{"map_aqi"}\NormalTok{]] <-}\StringTok{ }\KeywordTok{renderLeaflet}\NormalTok{(...)}
    \CommentTok{## Reactivity and event handling}
\NormalTok{  \}}
  \KeywordTok{moduleServer}\NormalTok{(id, module)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

The shiny modules are separated via namespacing, which is achieved by the definition of the functions of module servers. The namespace of each module is uniquely identified and called by a caller-defined \texttt{id} for both the module UI and server, which allows for the reuse of modules under different \texttt{id}. The namespace is called by a module-specific function, defined by the \texttt{NS(id)}, in the module UI and stored in the shiny session, which is the basis of referral of graphics outputs in the module UI rendered in the module server. In the context of the interactive-map module, the interactive map with the output \texttt{id} of \texttt{"map\_aqi"} is called dependently via the module-specific namespace function \texttt{ns()}.

Once defined, the modules are called in the application UI and server.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{app_server <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(input, output, session) \{}
  \CommentTok{## Application Initialisation}
  \CommentTok{## Other shiny module servers}
  \KeywordTok{map_aqi_mod}\NormalTok{(}\StringTok{"map_aqi"}\NormalTok{, app_state)}
  \CommentTok{## Reactivity and event handling}
\NormalTok{\}}

\NormalTok{app_ui <-}\StringTok{ }\KeywordTok{dashboardPage}\NormalTok{(}
\NormalTok{  header,}
\NormalTok{  sidebar,}
  \DataTypeTok{body =} \KeywordTok{dashboardBody}\NormalTok{(}
    \KeywordTok{tabItem}\NormalTok{(tabName,}
      \KeywordTok{fluidRow}\NormalTok{(}\KeywordTok{column}\NormalTok{(}\KeywordTok{map_aqi_ui}\NormalTok{(}\StringTok{"map_aqi"}\NormalTok{))),}
      \CommentTok{## Other modular UI}
\NormalTok{    ),}
    \CommentTok{## Other tabs}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{sec:shiny-event}{%
\subsection{Event observation and handling}\label{sec:shiny-event}}

The observation of events initiates evaluations in reactive programming, enabling the implementation of user-input monitoring in shiny applications, achieved via the \textbf{shiny} \texttt{observeEvent()} function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{map_aqi_mod <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(id, state) \{}
\NormalTok{  module <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(input, output, session) \{}
    \CommentTok{## Shiny output}
    \KeywordTok{observeEvent}\NormalTok{(input[[}\StringTok{"map_aqi_marker_click"}\NormalTok{]], \{}
\NormalTok{      state[[}\StringTok{"map_onclick"}\NormalTok{]] <-}\StringTok{ }\NormalTok{input[[}\StringTok{"map_aqi_marker_click"}\NormalTok{]][[}\StringTok{"id"}\NormalTok{]]}
\NormalTok{    \})}
\NormalTok{  \}}
  \KeywordTok{moduleServer}\NormalTok{(id, module)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Contextually, the interactive-map module monitors user clicks on the map items defined by the \emph{event expression}. The JavaScript-based interactive web map rendered by the \textbf{leaflet} package \autocite{leaflet} automatically generates callback inputs to the shiny session whose change is treated as an event upon user map clicks, which triggers the evaluation of the \emph{handler expression}. Other than callback events generated from interactive graphics, observable events include direct user inputs from the main UI.

\hypertarget{module-communication}{%
\subsection{Module communication}\label{module-communication}}

The communication between the namespace-isolated modules is facilitated with a \textbf{shiny} reactive object which collectively stores the current states of the application. The reactive object is shared and updated simultaneously by all modules and holds the \emph{one version of truth} at any given point in time. The reactive object is also subsettable such that the update of values is achievable with the assignment operator in the same way that objects are updated in a \texttt{list} object (Section \ref{sec:shiny-event}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aqi_heatmap_mod <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(id, }\DataTypeTok{state =}\NormalTok{ app_state) \{}
\NormalTok{  module <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(input, output, session) \{}
    \CommentTok{## Use app_state by calling state[[app_state_name]]}
    \CommentTok{## Update app_state by calling state[[app_state_name]] <-}
    \CommentTok{## Shiny output}
\NormalTok{  \}}
  \KeywordTok{moduleServer}\NormalTok{(id, module)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

The reactive object \texttt{app\_state} is stored in the application server and called upon the evaluation of all module server functions as an argument, and the update of which in any module is global for all others. Thus, the information of the user map clicks can be shared instantaneously for the graphics modules.

\hypertarget{reactive-caching}{%
\section{Reactive caching}\label{reactive-caching}}

\hypertarget{data-caching}{%
\subsection{Data caching}\label{data-caching}}

Exhaustive loading of the data with over 1 million observations incurs an undesirably long initialisation time upon application launch. As the application interface displays interactive graphics with data from only one location at a time, the initialisation upon application launch loads only the data of the default initial location (i.e., Queen Street, which is changeable). Upon detecting the user selection of a location with unloaded data, the data is updated by appending the corresponding data set to the cached data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{initial_app_state <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}
  \DataTypeTok{data =} \KeywordTok{append_data}\NormalTok{(}\OtherTok{NULL}\NormalTok{, }\StringTok{"queen_street"}\NormalTok{),}
  \DataTypeTok{map_onclick =} \StringTok{"Queen Street"}
\NormalTok{)}

\NormalTok{app_server <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(input, output, session) \{}
\NormalTok{  app_state <-}\StringTok{ }\KeywordTok{eval_tidy}\NormalTok{(}\KeywordTok{new_quosure}\NormalTok{(}\KeywordTok{expr}\NormalTok{(}
    \KeywordTok{reactiveValues}\NormalTok{(}\OperatorTok{!!!}\NormalTok{initial_app_state)}
\NormalTok{  )))}
  \CommentTok{## Shiny module servers}
  \CommentTok{## Reactivity and event handling}
\NormalTok{\}}

\NormalTok{append_data <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(data, loc) \{}
  \KeywordTok{paste0}\NormalTok{(}\StringTok{"data/"}\NormalTok{, }\KeywordTok{gsub}\NormalTok{(}\StringTok{"_"}\NormalTok{, }\StringTok{"-"}\NormalTok{, loc), }\StringTok{".csv"}\NormalTok{) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{read_csv}\NormalTok{(...) }\OperatorTok{%>%}
\StringTok{    }\CommentTok{## Wrangling}
\StringTok{    }\KeywordTok{bind_rows}\NormalTok{(data)}
\NormalTok{\}}

\NormalTok{app_server <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(input, output, session) \{}
  \CommentTok{## Application Initialisation}
  \CommentTok{## Shiny module servers}
  \KeywordTok{observeEvent}\NormalTok{(app_state[[}\StringTok{"map_onclick"}\NormalTok{]], \{}
    \ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\NormalTok{loc }\OperatorTok{%in%}\StringTok{ }\NormalTok{app_state[[}\StringTok{"data"}\NormalTok{]][[}\StringTok{"location"}\NormalTok{]]) \{}
\NormalTok{      app_state[[}\StringTok{"data"}\NormalTok{]] <-}\StringTok{ }\KeywordTok{append_data}\NormalTok{(app_state[[}\StringTok{"data"}\NormalTok{]], loc)}
\NormalTok{    \}}
    \CommentTok{## Data processing}
    \CommentTok{## Update shiny inputs}
\NormalTok{  \})}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

To prevent the graphics from rendering before the required data is loaded, an availability check of the data from the specified location is performed before the evaluation continues.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aqi_heatmap_mod <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(id, }\DataTypeTok{state =}\NormalTok{ app_state) \{}
\NormalTok{  module <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(input, output, session) \{}
    \CommentTok{## Data processing}
\NormalTok{    output[[}\StringTok{"aqi_heatmap"}\NormalTok{]] <-}\StringTok{ }\KeywordTok{renderEcharts4r}\NormalTok{(\{}
\NormalTok{      loc <-}\StringTok{ }\KeywordTok{make_clean_names}\NormalTok{(state[[}\StringTok{"map_onclick"}\NormalTok{]])}
      \KeywordTok{req}\NormalTok{(loc }\OperatorTok{%in%}\StringTok{ }\NormalTok{state[[}\StringTok{"data"}\NormalTok{]][[}\StringTok{"location"}\NormalTok{]])}
      \CommentTok{## Render shiny output}
\NormalTok{    \})}
\NormalTok{  \}}
  \KeywordTok{moduleServer}\NormalTok{(id, module)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{graphics-caching}{%
\subsection{Graphics caching}\label{graphics-caching}}

Interactive graphics, notwithstanding already optimised for web applications, may take a considerable amount of time to load. As such, the caching of rendered graphics in the current session improves the performance of reloading the same graphics by calls to the \textbf{shiny} \texttt{bindCache()} function, with the keys being the arguments. The keys are variables from which a collectively unique graphic is rendered.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aqi_heatmap_mod <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(id, }\DataTypeTok{state =}\NormalTok{ app_state) \{}
\NormalTok{  module <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(input, output, session) \{}
    \CommentTok{## Reactivity and event handling}
    \CommentTok{## Data processing}
\NormalTok{    output[[}\StringTok{"aqi_heatmap"}\NormalTok{]] <-}\StringTok{ }\KeywordTok{renderEcharts4r}\NormalTok{(expr) }\OperatorTok{%>%}
\StringTok{      }\KeywordTok{bindCache}\NormalTok{(...)}
\NormalTok{  \}}
  \KeywordTok{moduleServer}\NormalTok{(id, module)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{client-side-interactive-linking}{%
\subsection{Client-side interactive linking}\label{client-side-interactive-linking}}

In some scenarios, graphical database queries can be used to bypass the server to facilitate client-side interactive linking with \textbf{echarts4r} \autocite{echarts4r}. Client-side interactive linking calls the query with internal function \texttt{e\_connect()}, which links a set of \texttt{echarts4r} objects mutually rendered in the same \textbf{shiny} application. The linking is established with the mutual keys (i.e., \texttt{x} argument) of the objects upon initialising the interactive plots. In particular, client-side linking simplifies the implementation of mutual tooltips and selection control of the interactive calendar heatmaps and wind roses.

\hypertarget{ch:conclusion}{%
\chapter{Conclusion and future works}\label{ch:conclusion}}

\hypertarget{future-work}{%
\section{Future work}\label{future-work}}

\hypertarget{statistical-modelling}{%
\subsection{Statistical modelling}\label{statistical-modelling}}

\hypertarget{aspect-ratio-adaptation}{%
\subsection{Aspect ratio adaptation}\label{aspect-ratio-adaptation}}

\hypertarget{connection-to-dynamic-database}{%
\subsection{Connection to dynamic database}\label{connection-to-dynamic-database}}

\hypertarget{graphics-performance}{%
\subsection{Graphics performance}\label{graphics-performance}}

\hypertarget{final-words}{%
\section{Final words}\label{final-words}}

\appendix

\hypertarget{ch:model-output}{%
\chapter{Outputs from data analysis}\label{ch:model-output}}

\hypertarget{anova-table-of-the-final-models}{%
\section{ANOVA table of the final models}\label{anova-table-of-the-final-models}}

\begin{verbatim}
$glen_eden
Analysis of Variance Table

Response: aqi
                Df Sum Sq Mean Sq  F value    Pr(>F)    
lag_1            1  46789   46789 791.2044 < 2.2e-16 ***
lag_3            1   1632    1632  27.6011 1.661e-07 ***
t                1     64      64   1.0856  0.297574    
temp             1   1623    1623  27.4384 1.804e-07 ***
wind_dir        11   1700     155   2.6126  0.002628 ** 
ws               1    112     112   1.8910  0.169251    
temp:wind_dir   11   1845     168   2.8357  0.001098 ** 
wind_dir:ws     11   2383     217   3.6640 3.617e-05 ***
Residuals     1873 110762      59                       
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

$henderson
Analysis of Variance Table

Response: aqi
              Df Sum Sq Mean Sq   F value    Pr(>F)    
lag_1          1  47438   47438 1136.2540 < 2.2e-16 ***
lag_2          1    518     518   12.4138 0.0004363 ***
lag_3          1    731     731   17.5190 2.975e-05 ***
rh             1    180     180    4.3166 0.0378780 *  
t              1    295     295    7.0664 0.0079209 ** 
temp           1    668     668   16.0044 6.564e-05 ***
wind_dir      11   1183     108    2.5763 0.0030214 ** 
ws             1    407     407    9.7464 0.0018241 ** 
wind_dir:ws   11   2369     215    5.1578 5.016e-08 ***
Residuals   1883  78614      42                        
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

$patumahoe
Analysis of Variance Table

Response: aqi
            Df  Sum Sq Mean Sq F value    Pr(>F)    
lag_1        1  548186  548186 431.289 < 2.2e-16 ***
lag_2        1  120972  120972  95.176 < 2.2e-16 ***
lag_3        1   27496   27496  21.633 3.528e-06 ***
Residuals 1909 2426416    1271                      
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

$queen_street
Analysis of Variance Table

Response: aqi
              Df Sum Sq Mean Sq  F value    Pr(>F)    
lag_1          1  50908   50908 810.1483 < 2.2e-16 ***
lag_2          1   2079    2079  33.0799 1.118e-08 ***
lag_3          1    189     189   3.0019  0.083422 .  
wind_dir      11   3831     348   5.5423 1.051e-08 ***
ws             1     80      80   1.2802  0.258076    
wind_dir:ws   11   1749     159   2.5301  0.003702 ** 
Residuals   1218  76536      63                       
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

$takapuna
Analysis of Variance Table

Response: aqi
            Df  Sum Sq Mean Sq  F value    Pr(>F)    
lag_1        1  802004  802004 310.9659 < 2.2e-16 ***
lag_2        1  124517  124517  48.2799 5.054e-12 ***
lag_3        1   30707   30707  11.9061 0.0005717 ***
t            1   31137   31137  12.0730 0.0005230 ***
temp         1    8075    8075   3.1310 0.0769755 .  
ws           1    6004    6004   2.3281 0.1272215    
Residuals 1906 4915714    2579                       
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

\begin{table}[ht]
\begin{center}
\begin{tabular}{ll}
\toprule
Variable Code & Variable Description \\
\midrule
{\fontfamily{pcr}\selectfont aqi} & AQI (response) \\
{\fontfamily{pcr}\selectfont t} & Date in number of days since the Unix epoch of Jan 1, 1970 \\
{\fontfamily{pcr}\selectfont lag\_*} & Lagged responses \\
{\fontfamily{pcr}\selectfont temp} & Temperature in $^{\circ}$C \\
{\fontfamily{pcr}\selectfont ws} & Wind speed in ms\textsuperscript{-1} \\
{\fontfamily{pcr}\selectfont wind\_dir} & Wind direction (factor) \\
{\fontfamily{pcr}\selectfont rh} & Relative humidity in \% \\
\bottomrule
\end{tabular}
\caption{Notes for variable names to the ANOVA tables above.}
\end{center}
\end{table} 
\newpage

\hypertarget{correlation-structure-of-the-data}{%
\section{Correlation structure of the data}\label{correlation-structure-of-the-data}}

\includegraphics[width=1\linewidth]{thesis_files/figure-latex/unnamed-chunk-11-1}
\includegraphics[width=1\linewidth]{thesis_files/figure-latex/unnamed-chunk-11-2}
\includegraphics[width=1\linewidth]{thesis_files/figure-latex/unnamed-chunk-11-3}
\includegraphics[width=1\linewidth]{thesis_files/figure-latex/unnamed-chunk-11-4}
\includegraphics[width=1\linewidth]{thesis_files/figure-latex/unnamed-chunk-11-5}

\hypertarget{model-diagnostics-for-residual-correlation}{%
\section{Model diagnostics for residual correlation}\label{model-diagnostics-for-residual-correlation}}

\includegraphics[width=1\linewidth]{thesis_files/figure-latex/unnamed-chunk-12-1}
\includegraphics[width=1\linewidth]{thesis_files/figure-latex/unnamed-chunk-12-2}
\includegraphics[width=1\linewidth]{thesis_files/figure-latex/unnamed-chunk-12-3}
\includegraphics[width=1\linewidth]{thesis_files/figure-latex/unnamed-chunk-12-4}
\includegraphics[width=1\linewidth]{thesis_files/figure-latex/unnamed-chunk-12-5}
\newpage

\hypertarget{root-mean-squared-error-of-prediction-of-the-models}{%
\section{Root mean squared error of prediction of the models}\label{root-mean-squared-error-of-prediction-of-the-models}}

\begin{verbatim}
$glen_eden
[1] 8.861554

$henderson
[1] 20.29296

$patumahoe
[1] 7.496172

$queen_street
[1] 8.733452

$takapuna
[1] 8.397135
\end{verbatim}

\printbibliography[heading=bibintoc]



\end{document}
